--[[
  Copyright (C) 2011-2021 G. Bajlekov

    Ivy is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Ivy is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
]]

--[[
    Lens profile data obtained from the lensfun project

		Website: http://lensfun.sourceforge.net/
		Sourceforge: http://sourceforge.net/projects/lensfun/

    The lens database is licensed under the Creative Commons Attribution-Share
    Alike 3.0 license. You can read it here:
    http://creativecommons.org/licenses/by-sa/
--]]

local data = {
	["OLYMPUS M.12mm F2.0"] = {
		distortion = {
			[12] = {0.0, -0.028892, 0.0},
		},
		tca = {
			[12] = {0.0000301, 0.0, 1.0003354, 0.0000561, 0.0, 0.9999414},
		},
		vignetting = {
			[12] = {
				[2] = {-0.6818, -0.1021, 0.1981},
				[2.8] = {-0.1391, -0.0336, -0.1603},
				[4] = {-0.2327, -0.0190, 0.0492},
				[5.6] = {-0.1964, -0.0877, 0.0884},
				[22] = {-0.2630, 0.0244, 0.0320},
			},
		},
	},

	["OLYMPUS M.17mm F1.8"] = {
		distortion = {
			[17] = {0.01989, -0.09761, 0.07461},
		},
		tca = {
			[17] = {-0.0000767, 0.0, 1.0002674, 0.0001410, 0.0, 0.9997845},
		},
		vignetting = {
			[17] = {
				[1.8] = {-0.7165, -0.1724, 0.2618},
				[2] = {-0.2970, -0.8478, 0.5771},
				[2.2] = {-0.1159, -0.9493, 0.5634},
				[2.5] = {-0.1926, -0.5268, 0.2468},
				[2.8] = {-0.3038, -0.1389, -0.0033},
				[3.2] = {-0.3886, 0.1099, -0.1365},
				[3.5] = {-0.4553, 0.2344, -0.1723},
				[4] = {-0.4343, 0.1261, -0.0464},
				[5.6] = {-0.4624, 0.1259, -0.0118},
				[8] = {-0.4832, 0.1635, -0.0335},
				[11] = {-0.4916, 0.1791, -0.0422},
				[16] = {-0.4955, 0.1790, -0.0402},
				[22] = {-0.5138, 0.2068, -0.0567},
			},
		},
	},

	["OLYMPUS M.25mm F1.8"] = {
		distortion = {
			[25] = {0.00454, -0.0141, 0.00283},
		},
		tca = {
			[25] = {0.0, 0.0, 1.0003, 0.0, 0.0, 1.0001}
		},
		vignetting = {
			[25] = {
				[1.8] = {-0.9318, 0.5595, -0.1813},
				[2] = {-0.4885, -0.3012, 0.2847},
				[2.2] = {-0.1527, -0.8429, 0.5227},
				[2.5] = {-0.0485, -0.7477, 0.3542},
				[2.8] = {-0.1069, -0.3737, 0.0628},
				[3.2] = {-0.2257, 0.0951, -0.2530},
				[3.5] = {-0.2867, 0.2934, -0.3649},
				[4] = {-0.3230, 0.3698, -0.3610},
				[4.5] = {-0.3143, 0.2979, -0.2642},
				[5] = {-0.2860, 0.1647, -0.1305},
				[7.1] = {-0.2628, 0.0491, -0.0215},
				[22] = {-0.2533, 0.0122, -0.0029},
			},
		},
	},

	["OLYMPUS M.45mm F1.8"] = {
		distortion = {
			[45] = {0.00149954, -0.0023693, 0.00382496},
		},
		tca = {
			[45] = {-0.0000484, 0.0, 1.0001937, 0.0000056, 0.0, 0.9999340}
		},
		vignetting = {
			[45] = {
				[1.8] = {-0.2785, -0.0510, 0.0102},
				[2] = {-0.0571, -0.1512, -0.0265},
				[2.8] = {-0.1069, -0.0244, 0.0285},
				[4] = {-0.1091, -0.0196, 0.0259},
				[22] = {-0.1341, 0.0328, -0.0102},
			},
		},
	},

	["OLYMPUS M.30mm F3.5 Macro"] = {
		tca = {
			[30] = {0.0, 0.0, 1.0003510, 0.0, 0.0, 0.9999575}
		},
		vignetting = {
			[30] = {
				[3.5] = {-0.8317, 0.1958, 0.0861},
				[4] = {-0.4314, -0.3754, 0.3552},
				[4.5] = {-0.2734, -0.2775, 0.1870},
				[5] = {-0.3232, 0.0188, -0.0239},
				[5.6] = {-0.3873, 0.1280, -0.0148},
				[6.3] = {-0.4004, 0.1949, -0.0913},
				[22] = {-0.3666, 0.0752, 0.0327},
			},
		},
	},

	["LUMIX G VARIO 12-32/F3.5-5.6"] = {
		distortion = {
			[12] = {0.02222, -0.06354, -0.05077},
			[14] = {0.02389, -0.07355, 0.00922},
			[20] = {0, -0.0088, 0},
			[32] = {0, 0.00353, 0},
		},
		tca = {
			[12] = {-0.0000213, 0.0, 1.0002074, -0.0000183, 0.0, 1.0002135},
			[14] = {0.0000115, 0.0, 1.0001642, 0.0000508, 0.0, 1.0001012},
			[20] = {-0.0000057, 0.0, 1.0001348, -0.0000052, 0.0, 1.0001246},
			[32] = {-0.0000680, 0.0, 1.0001404, -0.0000581, 0.0, 1.0001761},
		},
		vignetting = {
			[12] = {
				[3.5] = {-0.8315, 0.4291, -0.3420},
				[4.5] = {-0.3630, 0.0319, -0.2708},
				[5.6] = {-0.5284, 0.6500, -0.5847},
				[7.1] = {-0.4779, 0.4199, -0.3299},
				[22] = {-0.4093, 0.1096, -0.0236},
			},
			[15] = {
				[3.7] = {-0.9290, 0.7907, -0.3447},
				[4.5] = {-0.3088, -0.3661, 0.2844},
				[5.6] = {-0.3571, 0.0906, -0.0549},
				[7.1] = {-0.3526, 0.0512, 0.0182},
				[22] = {-0.3604, 0.0632, 0.0229},
			},
			[18] = {
				[4.2] = {-0.8687, 0.7672, -0.3187},
				[5.6] = {-0.2683, -0.0907, 0.0562},
				[7.1] = {-0.3135, 0.0569, 0.0081},
				[8] = {-0.3159, 0.0746, -0.0048},
				[22] = {-0.3282, 0.0680, 0.0134},
			},
			[26] = {
				[5.3] = {-0.6776, 0.5047, -0.1996},
				[6.3] = {-0.2575, -0.0982, 0.0729},
				[8] = {-0.3336, 0.1781, -0.0909},
				[9] = {-0.3205, 0.1139, -0.0288},
				[22] = {-0.3211, 0.0811, 0.0149},
			},
			[32] = {
				[5.6] = {-0.6432, 0.5043, -0.2315},
				[7.1] = {-0.3381, 0.2127, -0.1687},
				[8] = {-0.3610, 0.2651, -0.1630},
				[9] = {-0.3450, 0.1998, -0.1028},
				[22] = {-0.3200, 0.0798, 0.0159},
			},
		},
	},

	["LUMIX G VARIO 35-100/F4.0-5.6"] = {
		distortion = {
			[35] = {0.00663258, -0.0185251, 0.0134508},
			[40] = {0.00258479, -0.00661156, 0.00697864},
			[45] = {0.000553098, 0.00439218, -0.00355882},
			[50] = {0.000346598, 0.00614855, -0.00173778},
			[62] = {-0.000115581, 0.00511291, 0.00988016},
			[78] = {-0.0104497, 0.039446, -0.0251468},
			[100] = {-0.0131383, 0.0562571, -0.0528326},
		},
		tca = {
			[35] = {0.0, 0.0, 1.0001700, 0.0, 0.0, 1.0003000},
			[40] = {0.0, 0.0, 1.0000925, 0.0, 0.0, 1.0002249},
			[45] = {0.0, 0.0, 1.0000558, 0.0, 0.0, 1.0001441},
			[50] = {0.0, 0.0, 1.0000459, 0.0, 0.0, 1.0001676},
			[62] = {0.0, 0.0, 0.9999844, 0.0, 0.0, 1.0000683},
			[78] = {0.0, 0.0, 0.9999536, 0.0, 0.0, 0.9999292},
			[100] = {0.0, 0.0, 0.9999000, 0.0, 0.0, 0.9996000},
		},
		vignetting = {
			[35] = {
				[4] = {-0.3482, -0.8294, 0.6100},
				[5] = {-0.0425, -0.6473, 0.2564},
				[6.3] = {-0.3028, 0.3163, -0.3103},
				[8] = {-0.3346, 0.3611, -0.2345},
				[22] = {-0.2978, 0.1716, -0.0257},
			},
			[43] = {
				[4.5] = {-0.1667, -0.6432, 0.3941},
				[5.6] = {-0.2344, 0.1884, -0.1793},
				[7.1] = {-0.2485, 0.1354, -0.0364},
				[8] = {-0.2573, 0.1447, -0.0406},
				[22] = {-0.2820, 0.1524, -0.0121},
			},
			[56] = {
				[5.3] = {-0.1399, -0.0786, -0.1011},
				[6.3] = {-0.2153, 0.1822, -0.1077},
				[8] = {-0.2045, 0.1083, -0.0298},
				[9] = {-0.2045, 0.0870, -0.0132},
				[22] = {-0.1830, 0.0189, 0.0552},
			},
			[75] = {
				[5.6] = {0.0735, -0.7851, 0.3877},
				[7.1] = {-0.2020, 0.2781, -0.2433},
				[8] = {-0.1918, 0.1826, -0.1230},
				[9] = {-0.1670, 0.0908, -0.0359},
				[22] = {-0.1749, 0.0503, 0.0324},
			},
			[100] = {
				[5.6] = {0.0551, -0.8705, 0.4779},
				[7.1] = {-0.0784, -0.0674, -0.0420},
				[8] = {-0.1715, 0.1753, -0.1402},
				[9] = {-0.1540, 0.1292, -0.0843},
				[22] = {-0.1578, 0.0430, 0.0343},
			},
		},
	},

	["DSC-RX100M3"] = {
		distortion = {
			[ 8.8] = {0.02266, -0.09581, 0.00190},
			[10.9] = {0.02376, -0.09457, 0.03217},
			[13.0] = {0.02326, -0.08674, 0.04569},
			[14.7] = {0.02340, -0.08395, 0.04970},
			[16.6] = {0.02045, -0.06253, 0.02684},
			[20.0] = {0.02295, -0.06814, 0.05127},
			[25.7] = {0.02377, -0.06078, 0.04156},
		},
		tca = {
			[ 8.8] = {0.0001786, 0.0, 1.0000881, -0.0001087, 0.0, 1.0003934},
			[10.9] = {0.0000887, 0.0, 1.0001670, -0.0000723, 0.0, 1.0003152},
			[13.0] = {0.0000518, 0.0, 1.0002194, -0.0000203, 0.0, 1.0001770},
			[14.7] = {0.0000185, 0.0, 1.0002369, -0.0000000, 0.0, 1.0001315},
			[16.6] = {0.0000075, 0.0, 1.0002936, -0.0000085, 0.0, 1.0000657},
			[20.0] = {-0.0000081, 0.0, 1.0003041, 0.0000035, 0.0, 1.0000616},
			[25.7] = {-0.0000121, 0.0, 1.0002604, 0.0000035, 0.0, 1.0000797},
		},
	},

	--Olympus Zuiko Digital ED 14-42mm f/3.5-5.6
	["OLYMPUS 14-42mm Lens"] = {
		distortion = {
			[14] = {0.0100665, -0.0270472, 0.0022372},
			[18] = {-0.00368686, 0.00286171, -0.0102343},
			[25] = {-1.55769e-05, -2.09253e-05, -0.00318557},
			[35] = {-0.00265046, 0.00843281, -0.00647169},
			[42] = {-0.00342208, 0.0114471, -0.0105329},
		},
		tca = {
			[14] = {-0.0000061, 0.0, 1.0003376, -0.0000092, 0.0, 1.0000329},
			[18] = {-0.0001031, 0.0, 1.0003988, 0.0000126, 0.0, 0.9999971},
			[25] = {-0.0001150, 0.0, 1.0003942, 0.0000327, 0.0, 0.9998980},
			[35] = {-0.0000998, 0.0, 1.0003497, 0.0000562, 0.0, 0.9997683},
			[42] = {-0.0000307, 0.0, 1.0001997, 0.0000116, 0.0, 0.9997666},
		},
	},

	--Olympus Zuiko Digital 35mm f/3.5 Macro
	["OLYMPUS 35mm Lens"] = {
		distortion = {
			[35] = {-0.00226197, 0.00228625, -0.00756547},
		},
		tca = {
			[35] = {-0.0000953, 0.0, 1.0002105, -0.0000137, 0.0, 01.0000230},
		},
	},

	--Olympus Zuiko Digital ED 40-150mm f/4.0-5.6
	["OLYMPUS 40-150mm Lens"] = {
		distortion = {
			[40] = {-0.0069552, 0.0128954, -0.0201501},
			[50] = {-0.00328196, 0.00547778, -0.00507713},
			[73] = {0.00269235, -0.00470212, 0.00974549},
			[98] = {-0.00377975, 0.0155413, -0.00903773},
			[150] = {-0.000293389, 0.00701827, -0.00528205},
		},
		tca = {
			[40] = {-0.0000434, 0.0, 1.0004182, 0.0000176, 0.0, 0.9998313},
			[50] = {0.0000574, 0.0, 1.0002451, -0.0000307, 0.0, 0.9998156},
			[73] = {0.0000138, 0.0, 1.0001119, -0.0001086, 0.0, 0.9997898},
			[102] = {0.0000541, 0.0, 0.9998625, -0.0000497, 0.0, 0.9997776},
			[150] = {0.0000230, 0.0, 0.9997236, -0.0000526, 0.0, 0.9999016},
		},
	},

	["SIGMA 56mm F1.4 DC DN | C 018"] = {
		distortion = {
			[56] = {0.007021, -0.007566, 0.016321} -- panorama
			--[56] = {0.002311, 0.005746, 0.001967} -- jpeg reference
			--[56] = {-0.008811, 0.043041, -0.046179} -- line reference
		},
	},

	["OLYMPUS M.12-45mm F4.0"] = {
		distortion = {
			[12] = {0.029241, -0.093308,  0.008580},
			[14] = {0.015286, -0.053747,  0.003764},
			[17] = {0.009803, -0.033109,  0.009735},
			[25] = {0.020134, -0.061420,  0.062531},
			[35] = {-0.00673,  0.027454, -0.010543},
			[45] = {0.008573, -0.015433,  0.022007},
		},
	}
}


local function interpolate(data, fl)
	local below, above = 0, math.huge
	local min, max = math.huge, 0
	for k, v in pairs(data) do
		if k < min then min = k end
		if k > max then max = k end

		if k < fl then
			if (fl - k) < (fl - below) then below = k end
		elseif k > fl then
			if (k - fl) < (above - fl) then above = k end
		end
	end

	if fl <= min then return data[min] end
	if fl >= max then return data[max] end

	assert(below > 0)
	assert(above < math.huge)

	local o = {}
	local factor = (fl - below) / (above - below)
	for k, v in ipairs(data[below]) do
		o[k] = data[below][k] + factor * (data[above][k] - data[below][k])
	end
	return o
end

local function interpolate2(data, fl, ap)
	local below, above = 0, math.huge
	local min, max = math.huge, 0
	for k, v in pairs(data) do
		if k < min then min = k end
		if k > max then max = k end

		if k < fl then
			if (fl - k) < (fl - below) then below = k end
		elseif k > fl then
			if (k - fl) < (above - fl) then above = k end
		end
	end

	if fl <= min then return data[min] end
	if fl >= max then return data[max] end

	assert(below > 0)
	assert(above < math.huge)

	local o = {}
	local factor = (fl - below) / (above - below)

	local data_below = interpolate(data[below], ap)
	local data_above = interpolate(data[above], ap)

	for k, v in ipairs(data_below) do
		o[k] = data_below[k] + factor * (data_above[k] - data_below[k])
	end
	return o
end

return function(lens, fl, ap)
	local A, B, C, BR, CR, VR, BB, CB, VB, K1, K2, K3 = 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0

	if not lens then return A, B, C, BR, CR, VR, BB, CB, VB, K1, K2, K3 end

	fl = tonumber(fl)
	ap = tonumber(ap)
	assert(type(lens) == "string")
	lens = lens:gsub("%c*$", "") -- remove embedded zeros

	if data[lens] then
		if data[lens].distortion then
			if data[lens].distortion[fl] then
				A, B, C = unpack(data[lens].distortion[fl])
			else
				A, B, C = unpack(interpolate(data[lens].distortion, fl))
			end
		end

		if data[lens].tca then
			if data[lens].tca[fl] then
				BR, CR, VR, BB, CB, VB = unpack(data[lens].tca[fl])
			else
				BR, CR, VR, BB, CB, VB = unpack(interpolate(data[lens].tca, fl))
			end
		end

		if data[lens].vignetting then
			if data[lens].vignetting[fl] then
				if data[lens].vignetting[fl][ap] then
					K1, K2, K3 = unpack(data[lens].vignetting[fl][ap])
				else
					K1, K2, K3 = unpack(interpolate(data[lens].vignetting[fl], ap))
				end
			else
				K1, K2, K3 = unpack(interpolate2(data[lens].vignetting, fl, ap))
			end
		end
	end

	return A, B, C, BR, CR, VR, BB, CB, VB, K1, K2, K3
end
